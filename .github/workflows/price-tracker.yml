name: Metal Price Tracker v2.0

on:
  schedule:
    # Her gün sabah 7:00'den akşam 21:00'a kadar her 30 dakikada bir
    # 04:00-18:00 UTC = 07:00-21:00 Türkiye saati (UTC+3)
    - cron: '0,30 4-18 * * *'
    
    # Gece optimizasyon işi - her gece 02:00 Türkiye saati
    # 23:00 UTC = 02:00 Türkiye saati (UTC+3)
    - cron: '0 23 * * *'
    
  workflow_dispatch: # Manuel tetikleme için

# Aynı anda tek workflow çalışmasını sağla
concurrency:
  group: metal-tracker
  cancel-in-progress: false

jobs:
  metal-tracker:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4
        
    - name: Create data directory
      run: |
        mkdir -p data
        
    - name: Determine operation based on time
      run: |
        # Türkiye saati hesapla (UTC+3)
        TURKEY_HOUR=$(date -u -d '+3 hours' +%H)
        TURKEY_MINUTE=$(date -u -d '+3 hours' +%M)
        CURRENT_UTC_HOUR=$(date -u +%H)
        
        echo "🕐 UTC Saati: $(date -u +%H:%M)"
        echo "🇹🇷 Türkiye Saati: $TURKEY_HOUR:$TURKEY_MINUTE"
        echo "📅 Tarih: $(date -u -d '+3 hours' +%Y-%m-%d)"
        
        # Gece optimizasyon kontrolü (02:00 Türkiye saati)
        if [ $TURKEY_HOUR -eq 2 ]; then
          echo "🌙 Gece optimizasyonu zamanı - başlatılıyor..."
          python scripts/price_tracker.py --optimize
          
        # Veri toplama saatleri kontrolü (07:00-21:00 Türkiye saati)
        elif [ $TURKEY_HOUR -ge 7 ] && [ $TURKEY_HOUR -lt 21 ]; then
          echo "📊 Veri toplama saatleri ($TURKEY_HOUR:$TURKEY_MINUTE) - başlatılıyor..."
          python scripts/price_tracker.py --collect
          
        else
          echo "⏰ Belirlenen saatler dışında ($TURKEY_HOUR:$TURKEY_MINUTE)"
          echo "   📊 Veri toplama: 07:00-21:00 TR"
          echo "   🌙 Optimizasyon: 02:00 TR"
          echo "   ❌ İşlem yapılmıyor"
          exit 0
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Metal Tracker Bot v2.0"
        
        # Remote değişiklikleri al
        echo "🔄 Fetching remote changes..."
        git fetch origin main
        
        # Değişiklik varsa commit et
        if [ -f data/price-history.json ]; then
          git add data/price-history.json
          
          # Commit mesajını operasyona göre belirle
          TURKEY_HOUR=$(date -u -d '+3 hours' +%H)
          
          if [ $TURKEY_HOUR -eq 2 ]; then
            COMMIT_MSG="🌙 Daily optimization: $(date -u -d '+3 hours -1 day' +%Y-%m-%d) peak data saved"
          else
            COMMIT_MSG="📊 Price update: $(date -u -d '+3 hours' +%Y-%m-%d\ %H:%M) TR"
          fi
          
          # Sadece değişiklik varsa commit yap
          git diff --staged --quiet || (
            echo "💾 Committing changes: $COMMIT_MSG"
            git commit -m "$COMMIT_MSG"
            
            # Pull ve push işlemi - konflikt durumunda retry
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "🔄 Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"
              
              # Remote değişiklikleri al ve merge et
              if git pull origin main --rebase; then
                echo "✅ Pull successful"
                
                # Push işlemi
                if git push origin main; then
                  echo "✅ Push successful"
                  break
                else
                  echo "⚠️ Push failed, retrying..."
                fi
              else
                echo "⚠️ Pull failed, retrying..."
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              # Son deneme değilse bekle
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⏳ Waiting 5 seconds before retry..."
                sleep 5
                
                # Yeniden fetch et
                git fetch origin main
              fi
            done
            
            # Tüm denemeler başarısız olduysa
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "❌ Failed to push after $MAX_RETRIES attempts"
              exit 1
            fi
          )
        else
          echo "❌ No data file found - skipping commit"
        fi
        
    - name: Print operation summary
      run: |
        TURKEY_HOUR=$(date -u -d '+3 hours' +%H)
        echo ""
        echo "📋 İşlem Özeti:"
        echo "==============="
        
        if [ $TURKEY_HOUR -eq 2 ]; then
          echo "🌙 Gece optimizasyonu tamamlandı"
          echo "   • Bir önceki günün peak değeri saklandı"
          echo "   • Diğer veriler temizlendi"
        else
          echo "📊 Veri toplama tamamlandı"
          echo "   • Altın fiyatı çekildi"
          echo "   • Gümüş fiyatı çekildi"
          echo "   • Portföy değeri hesaplandı"
        fi
        
        echo ""
        echo "⏰ Bir sonraki çalışma:"
        if [ $TURKEY_HOUR -eq 2 ]; then
          echo "   📊 07:00 TR (Veri toplama başlangıcı)"
        elif [ $TURKEY_HOUR -ge 20 ]; then
          echo "   🌙 02:00 TR (Gece optimizasyonu)"
        else
          echo "   📊 $(($TURKEY_HOUR + 1)):00 TR (Veri toplama devam)"
        fi
        
        echo ""
        echo "✅ Workflow başarıyla tamamlandı!"
