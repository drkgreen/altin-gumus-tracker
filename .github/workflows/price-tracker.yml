name: Metal Price Tracker v3.0

on:
  schedule:
    # Her gÃ¼n sabah 7:00'den akÅŸam 21:00'a kadar her 15 dakikada bir
    # 04:00-18:00 UTC = 07:00-21:00 TÃ¼rkiye saati (UTC+3)
    - cron: '0,15,30,45 4-18 * * *'
    
    # Gece temizlik iÅŸi - her gece 02:00 TÃ¼rkiye saati
    # 23:00 UTC = 02:00 TÃ¼rkiye saati (UTC+3)
    - cron: '0 23 * * *'
    
  workflow_dispatch: # Manuel tetikleme iÃ§in

permissions:
  contents: write

jobs:
  metal-tracker:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4
        
    - name: Create data directory
      run: |
        mkdir -p data
        
    - name: Determine operation based on time
      run: |
        # TÃ¼rkiye saati hesapla (UTC+3)
        TURKEY_HOUR=$(date -u -d '+3 hours' +%H)
        TURKEY_MINUTE=$(date -u -d '+3 hours' +%M)
        
        echo "ğŸ• UTC Saati: $(date -u +%H:%M)"
        echo "ğŸ‡¹ğŸ‡· TÃ¼rkiye Saati: $TURKEY_HOUR:$TURKEY_MINUTE"
        echo "ğŸ“… Tarih: $(date -u -d '+3 hours' +%Y-%m-%d)"
        
        # Gece temizlik kontrolÃ¼ (02:00 TÃ¼rkiye saati)
        if [ $TURKEY_HOUR -eq 2 ]; then
          echo "ğŸŒ™ Gece temizliÄŸi zamanÄ± - baÅŸlatÄ±lÄ±yor..."
          python scripts/price_tracker.py --cleanup
          
        # Veri toplama saatleri kontrolÃ¼ (07:00-21:59 TÃ¼rkiye saati)
        elif [ $TURKEY_HOUR -ge 7 ] && [ $TURKEY_HOUR -le 21 ]; then
          echo "ğŸ“Š Veri toplama saatleri ($TURKEY_HOUR:$TURKEY_MINUTE) - baÅŸlatÄ±lÄ±yor..."
          python scripts/price_tracker.py --collect
          
        else
          echo "â° Belirlenen saatler dÄ±ÅŸÄ±nda ($TURKEY_HOUR:$TURKEY_MINUTE)"
          echo "   ğŸ“Š Veri toplama: 07:00-21:59 TR"
          echo "   ğŸŒ™ Temizlik: 02:00 TR"
          echo "   âŒ Ä°ÅŸlem yapÄ±lmÄ±yor"
          exit 0
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "Metal Tracker Bot v3.0"
        
        # DeÄŸiÅŸiklik varsa commit et
        if [ -f data/price-history.json ]; then
          git add data/price-history.json
          
          # Commit mesajÄ±nÄ± operasyona gÃ¶re belirle
          TURKEY_HOUR=$(date -u -d '+3 hours' +%H)
          
          if [ $TURKEY_HOUR -eq 2 ]; then
            COMMIT_MSG="ğŸŒ™ Cleanup: $(date -u -d '+3 hours' +%Y-%m-%d) old raw data removed"
          else
            COMMIT_MSG="ğŸ“Š Update: $(date -u -d '+3 hours' +%Y-%m-%d\ %H:%M) TR + realtime optimization"
          fi
          
          # Sadece deÄŸiÅŸiklik varsa commit yap
          git diff --staged --quiet || (
            echo "ğŸ’¾ Committing changes: $COMMIT_MSG"
            git commit -m "$COMMIT_MSG"
            git push
          )
        else
          echo "âŒ No data file found - skipping commit"
        fi
        
    - name: Print operation summary
      run: |
        TURKEY_HOUR=$(date -u -d '+3 hours' +%H)
        echo ""
        echo "ğŸ“‹ Ä°ÅŸlem Ã–zeti:"
        echo "==============="
        
        if [ $TURKEY_HOUR -eq 2 ]; then
          echo "ğŸŒ™ Gece temizliÄŸi tamamlandÄ±"
          echo "   â€¢ DÃ¼nÃ¼n ham verileri silindi"
          echo "   â€¢ Peak veriler korundu"
        else
          echo "ğŸ“Š Veri toplama tamamlandÄ±"
          echo "   â€¢ AltÄ±n fiyatÄ± Ã§ekildi"
          echo "   â€¢ GÃ¼mÃ¼ÅŸ fiyatÄ± Ã§ekildi"
          echo "   â€¢ PortfÃ¶y deÄŸeri hesaplandÄ±"
          echo "   â€¢ AnlÄ±k optimizasyon yapÄ±ldÄ±"
          echo "     âœ“ GÃ¼nlÃ¼k peak gÃ¼ncellendi"
          echo "     âœ“ AylÄ±k peak gÃ¼ncellendi"
        fi
        
        echo ""
        echo "â° Bir sonraki Ã§alÄ±ÅŸma:"
        if [ $TURKEY_HOUR -eq 2 ]; then
          echo "   ğŸ“Š 07:00 TR (Veri toplama baÅŸlangÄ±cÄ±)"
        elif [ $TURKEY_HOUR -ge 20 ]; then
          echo "   ğŸŒ™ 02:00 TR (Gece temizliÄŸi)"
        else
          TURKEY_MINUTE=$(date -u -d '+3 hours' +%M)
          NEXT_MIN=$((10#$TURKEY_MINUTE + 15))
          NEXT_HOUR=$TURKEY_HOUR
          if [ $NEXT_MIN -ge 60 ]; then
            NEXT_MIN=$((NEXT_MIN - 60))
            NEXT_HOUR=$((NEXT_HOUR + 1))
          fi
          echo "   ğŸ“Š $(printf '%02d:%02d' $NEXT_HOUR $NEXT_MIN) TR (Veri toplama devam)"
        fi
        
        echo ""
        echo "âœ… Workflow baÅŸarÄ±yla tamamlandÄ±!"